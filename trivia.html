<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trivia v2.01</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            color: orangered;
            text-align: center;
            margin: 0;
            padding: 0;
			width: 100vw;
			height: 100vh;
        }
        #question {
			position: absolute;
			font-weight: bold;
			top: 20px;
			right: 8px;
			width: 65%;
			max-width: 700px;
			text-align: center;
			padding: 15px 20px;
			background: linear-gradient(135deg, #001f1f, #004040);
			border: 3px solid teal;
			border-radius: 12px;
			color: white;
			text-shadow: 2px 2px 4px rgba(0, 255, 255, 0.5);
			box-shadow: 0px 0px 12px rgba(0, 255, 255, 0.5);
			transition: transform 0.2s ease-in-out;
		}

		#question:hover {
			transform: scale(1.05); /* Slight hover effect for interactivity */
		}
        #leaderboard {
			position: absolute;
			top: 9%;
			font-size: 15px;
			right: 14px;
		}
		#leaderboard p {
			background: #001f1f;
			width: 155px;
			padding: 4px;
			margin: 0px;
			font-size: 18px;
			border: 2px outset #095656;
			border-radius: 0px;
		}
        #leaderboard li {
            margin: -6px 0 0px 0;
			text-align: center;
			padding: 4px 9px;
			width: ;
			max-width: ;
			background: linear-gradient(135deg, #001f1f, #004040);
			border: 3px solid teal;
			border-radius: 12px;
			color: #12ebeb;
			text-shadow: 1px 1px 4px rgb(0 255 239 / 65%);
			box-shadow: 0px 0px 12px rgb(0 255 239 / 65%);
			transition: transform 0.2s ease-in-out;
        }
		#correct-answer {
			position: absolute;
			top: 0px;
			right: 0px;
			font-size: 18px;
			padding: 6px;
			width: 261px;
			background: #004040f2;
			border-radius: 18px;
			color: #8d7c7f;
			z-index: 100;
		}
    </style>
</head>
<body>
    <div id="question">-</div>
	<div id="next-question-timer"></div>
    <div id="timer">30</div>
    <div id="correct-answer"></div>
    <ul id="leaderboard">
        <p>Leaderboard</p>
        <li>...</li>
    </ul>

    <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.js"></script>
<script>
	const triviaQuestions = [
		{ question: "converting 100 shrapnel results in how much universal ammo?", answer: "101" },
		{ question: "What number is on the side of a Sleipnir mk1 (C,L)?", answer: "88" },
		{ question: "What is 5 + 3?", answer: "8" },
		{ question: "Who painted the Mona Lisa?", answer: "da vinci" },
		{ question: "what is the smallest Skildek support weapon?", answer: "lancehead" },
		{ question: "what amp drops from bots found at orthos oilfield", answer: "b101" },
		{ question: "what does CDF stand for", answer: "calypso defense force" },
		{ question: "what does IFN stand for", answer: "imperial federal navy" },
		{ question: "what is Jaedraze's avatars first name", answer: "Jimmy" },
		{ question: "what is Jaedraze's avatars middle name", answer: "Jimbobbityboo" },
		{ question: "what year is it?", answer: "2025" },
		{ question: "what items are used to craft explosive projectiles?", answer: "nanocubes" },
		{ question: "what is the name of the starting zone on calypso", answer: "thule" },
		{ question: "how many paint cans or textures for max success?", answer: "323" },
		{ question: "how many ped is 100pec worth?", answer: "1" },
		{ question: "how many pec is 1ped worth?", answer: "100" },
		{ question: "how many pec is 10ped worth?", answer: "1000" },
		{ question: "if the questions answer is the fourth word of the question. what is the answer?", answer: "answer" },
	];

	let twitchUsersJoined = [];
	let userScores = {}; 
	let currentQuestionIndex = 0;
	let questionActive = false; 
	let timer;
	let countdown = 120; // 2 minutes (120 seconds)
	let nextQuestionCountdown = 180; // Time for next question (3 minutes)
	let firstAnswerGiven = false;
	let firstAnswerUser = '';

	// Randomize question order
	function getRandomQuestionIndex() {
		return Math.floor(Math.random() * triviaQuestions.length);
	}

	// Update question on overlay
	function updateQuestionDisplay() {
		currentQuestionIndex = getRandomQuestionIndex();
		document.getElementById("question").textContent = triviaQuestions[currentQuestionIndex].question;
		document.getElementById("question").style.border = "3px solid teal";
		document.getElementById("question").style.color = "white";
		document.getElementById("correct-answer").textContent = "";
		questionActive = true;
		startTimer();
	}

	// Update countdown for both the main timer and next question timer
	function updateCountdown() {
		document.getElementById("timer").textContent = countdown; // Update main countdown
		if (nextQuestionCountdown > 0) {
			let timeLeft = Math.ceil(nextQuestionCountdown / 1000); // Convert ms to seconds
			document.getElementById("next-question-timer").textContent = `Next question in: ${timeLeft}s`;
		} else {
			document.getElementById("next-question-timer").textContent = ""; // Hide if no timer
		}
	}

	// Handle the next question after the timer runs out
	function nextQuestion() {
		updateQuestionDisplay();
		resetCountdowns();
	}

	// Reset countdowns for the next question
	function resetCountdowns() {
		countdown = 120; // Reset to 120 seconds
		nextQuestionCountdown = 180; // Reset next question countdown to 3 minutes
		firstAnswerGiven = false; // Reset first answer flag
	}

	// Handle a correct answer
	function handleCorrectAnswer(user) {
		clearInterval(timer);
		document.getElementById("question").style.border = "3px solid green";
		document.getElementById("question").style.color = "lightgreen";
		document.getElementById("correct-answer").textContent = `${user} got it right! Answer: ${triviaQuestions[currentQuestionIndex].answer}.`;

		if (!firstAnswerGiven) {
			// First correct answer, give 3 points
			userScores[user] = (userScores[user] || 0) + 3;
			firstAnswerGiven = true;
			firstAnswerUser = user; // Track the user who answered first
			countdown = 120; // Set countdown to 120 seconds after first answer
		} else if (user !== firstAnswerUser) {
			// Late answers, give 1 point
			userScores[user] = (userScores[user] || 0) + 1;
		}

		updateLeaderboard();
		startNextQuestionTimer();
	}

	// Update the leaderboard
	function updateLeaderboard() {
		const leaderboardElement = document.getElementById("leaderboard");
		leaderboardElement.innerHTML = "<p>Leaderboard</p>";
		Object.entries(userScores)
			.sort((a, b) => b[1] - a[1])
			.forEach(([user, score]) => {
				const li = document.createElement("li");
				li.textContent = `${user}: ${score} pts`;
				leaderboardElement.appendChild(li);
			});
	}

	// Start the timer for the next question after 3 minutes
	function startNextQuestionTimer() {
		nextQuestionCountdown = 180; // 3 minutes in seconds
		let nextTimer = setInterval(() => {
			nextQuestionCountdown--;
			updateCountdown();
			if (nextQuestionCountdown <= 0) {
				clearInterval(nextTimer);
				nextQuestion(); // Move to the next question
			}
		}, 1000);
	}

	// Start the countdown timer
	function startTimer() {
		clearInterval(timer);
		timer = setInterval(() => {
			countdown--;
			updateCountdown();
			if (countdown <= 0) {
				clearInterval(timer);
				nextQuestion(); // Proceed to the next question
			}
		}, 1000);
	}

	// Listen for Twitch Commands
	ComfyJS.onCommand = (user, command, message, flags, extra) => {
		switch (command.toLowerCase()) {
			case "playtrivia":
				if (!twitchUsersJoined.includes(user)) {
					twitchUsersJoined.push(user);
					userScores[user] = 0; // Initialize score
				}
				break;
			case "trivia":
				updateQuestionDisplay();
				break;
		}
	};

	// Check for correct answers in chat
	ComfyJS.onChat = (user, message, flags, self, extra) => {
		if (!questionActive) return; // Ignore chat when no question is active
		message = message.toLowerCase(); // Normalize message to lowercase

		// Check if the answer is correct
		if (message === triviaQuestions[currentQuestionIndex].answer.toLowerCase()) {
			handleCorrectAnswer(user); // Call the function for the correct answer
		}
	};

	// Initialize Twitch connection
	ComfyJS.Init("jaedraze");

	// Start the first trivia question
	updateQuestionDisplay();
</script>

</body>
</html>
