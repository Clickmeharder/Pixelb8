<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Entropia Log Master (3GB+ Ready)</title>
	<link rel="icon" type="image/png" href="../assets/images/logo/pixelbotfavicon.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #121212; color: #eee; max-width: 900px; margin: 30px auto; padding: 20px; }
        .box { background: #1e1e1e; padding: 30px; border-radius: 12px; border: 1px solid #333; box-shadow: 0 8px 32px rgba(0,0,0,0.6); }
        h1 { color: #00aaff; text-align: center; margin-bottom: 30px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .card { background: #252525; padding: 15px; border-radius: 8px; border: 1px solid #444; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #00aaff; }
        select, input { background: #333; color: #fff; border: 1px solid #555; padding: 10px; border-radius: 4px; width: 100%; box-sizing: border-box; }
        
        #processBtn { background: #00aaff; color: white; padding: 15px; border: none; border-radius: 8px; width: 100%; cursor: pointer; font-size: 1.1em; font-weight: bold; margin-bottom: 20px; }
        #processBtn:hover { background: #0088cc; }
        #processBtn:disabled { background: #444; }

        #fileTable { width: 100%; border-collapse: collapse; margin-top: 20px; display: none; }
        #fileTable th { text-align: left; border-bottom: 2px solid #444; padding: 10px; color: #888; }
        #fileTable td { padding: 10px; border-bottom: 1px solid #333; }
        
        .dl-btn { background: #28a745; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; }
        #zipBtn { background: #f39c12; color: white; margin-top: 20px; width: 100%; padding: 15px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; display: none; }
        #status { text-align: center; font-weight: bold; color: #00aaff; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="box">
        <h1>Entropia Log Master</h1>
        
        <label>Step 1: Select chat.log</label>
        <input type="file" id="logInput" accept=".log,.txt" style="margin-bottom:20px;">

        <div class="grid">
            <div class="card">
                <label>Split Strategy</label>
                <select id="splitMode">
                    <option value="year">By Year</option>
                    <option value="month">By Month Group</option>
                    <option value="lines" selected>By Line Count</option>
                </select>
            </div>
            <div class="card" id="configArea">
                <label id="configLabel">Lines per file:</label>
                <input type="number" id="configValue" value="1000000">
            </div>
        </div>

        <button id="processBtn">Process & Prepare Files</button>
        <div id="status"></div>

        <table id="fileTable">
            <thead>
                <tr>
                    <th>Filename</th>
                    <th>Size (Est)</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="fileListBody"></tbody>
        </table>

        <button id="zipBtn">Download Everything as ZIP</button>
    </div>

    <script>
        let processedFiles = {}; 
        const splitMode = document.getElementById('splitMode');
        const configLabel = document.getElementById('configLabel');
        const configValue = document.getElementById('configValue');

        splitMode.onchange = () => {
            if (splitMode.value === 'year') {
                document.getElementById('configArea').style.visibility = 'hidden';
            } else if (splitMode.value === 'month') {
                document.getElementById('configArea').style.visibility = 'visible';
                configLabel.innerText = "Months per file:";
                configValue.value = "3";
            } else {
                document.getElementById('configArea').style.visibility = 'visible';
                configLabel.innerText = "Lines per file:";
                configValue.value = "1000000";
            }
        };

        document.getElementById('processBtn').onclick = async () => {
            const fileInput = document.getElementById('logInput');
            if (!fileInput.files.length) return alert("Select a file!");

            const file = fileInput.files[0];
            const status = document.getElementById('status');
            const table = document.getElementById('fileTable');
            const listBody = document.getElementById('fileListBody');
            
            // UI Reset
            processedFiles = {};
            listBody.innerHTML = '';
            table.style.display = 'none';
            document.getElementById('zipBtn').style.display = 'none';
            status.innerText = "Scanning 3GB file... please wait.";

            const stream = file.stream();
            const reader = stream.getReader();
            const decoder = new TextDecoder();
            let partialLine = '';
            let totalLines = 0;
            let currentFileKey = "Part_1";

            try {
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const text = decoder.decode(value, { stream: true });
                    const lines = (partialLine + text).split(/\r?\n/);
                    partialLine = lines.pop();

                    for (const line of lines) {
                        totalLines++;
                        
                        if (splitMode.value === 'year') {
                            const m = line.match(/^(\d{4})/);
                            if (m) currentFileKey = m[0];
                        } else if (splitMode.value === 'month') {
                            const m = line.match(/^(\d{4})-(\d{2})/);
                            if (m) {
                                const year = m[1];
                                const month = parseInt(m[2]);
                                const groupSize = parseInt(configValue.value);
                                const group = Math.ceil(month / groupSize);
                                currentFileKey = `${year}_Q${group}`;
                            }
                        } else {
                            if (totalLines % parseInt(configValue.value) === 0) {
                                currentFileKey = `Part_${Math.ceil(totalLines / configValue.value) + 1}`;
                            }
                        }

                        const fname = `entropia_${currentFileKey}.txt`;
                        if (!processedFiles[fname]) processedFiles[fname] = [];
                        processedFiles[fname].push(line);
                    }
                    if (totalLines % 500000 === 0) status.innerText = `Read ${totalLines.toLocaleString()} lines...`;
                }

                // Render Table
                for (let name in processedFiles) {
                    const content = processedFiles[name].join('\n');
                    processedFiles[name] = content; // Convert array back to string
                    const mbSize = (new Blob([content]).size / 1024 / 1024).toFixed(2);
                    
                    const row = `<tr>
                        <td>${name}</td>
                        <td>${mbSize} MB</td>
                        <td><button class="dl-btn" onclick="downloadSingle('${name}')">Download</button></td>
                    </tr>`;
                    listBody.innerHTML += row;
                }

                table.style.display = 'table';
                document.getElementById('zipBtn').style.display = 'block';
                status.innerText = "Analysis Complete.";

            } catch (e) {
                status.innerText = "Error: " + e.message;
            }
        };

        window.downloadSingle = (name) => {
            const blob = new Blob([processedFiles[name]], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = name;
            a.click();
            setTimeout(() => URL.revokeObjectURL(url), 1000);
        };

        document.getElementById('zipBtn').onclick = async () => {
            const zip = new JSZip();
            document.getElementById('status').innerText = "Compressing ZIP...";
            for (let name in processedFiles) {
                zip.file(name, processedFiles[name]);
            }
            const blob = await zip.generateAsync({type:"blob"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "Entropia_Log_Archive.zip";
            a.click();
            document.getElementById('status').innerText = "ZIP Downloaded!";
        };
    </script>
</body>
</html>