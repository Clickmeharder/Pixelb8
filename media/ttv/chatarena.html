<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chat Arena – Stickmen</title>
<script src="https://unpkg.com/comfy.js/dist/comfy.min.js"></script>
<style>
body {
    margin:0;
    background:none;
    color:#e0f7ff;
    font-family:monospace;
    overflow:hidden;
}
canvas { display:block; margin:auto; }
#ui {
    position:absolute;
    top:10px; left:10px;
}
.bar { width:300px; height:18px; background:#222; margin-bottom:6px; }
.fill { height:100%; background:#ff4444; }
.chat { background:#44ffcc; }
#boost {
    margin-top:6px;
    color:#ff0;
    font-weight:bold;
    display:none;
}
</style>
</head>

<body>

<canvas id="c" width="900" height="500"></canvas>

<div id="ui">
    BOSS HP
    <div class="bar"><div id="bossHP" class="fill"></div></div>
    CHAT HP
    <div class="bar"><div id="chatHP" class="fill chat"></div></div>
    <div id="boost">⚡ BOOST ACTIVE ⚡</div>
</div>

<script>
const c = document.getElementById("c");
const ctx = c.getContext("2d");

/* ================= STATE ================= */
let boss = {
    hp:1200, max:1200,
    horns: Math.random()>0.5,
    spikes: Math.floor(Math.random()*3)+1,
    eyes: Math.floor(Math.random()*3)+1
};
let chatHP = { hp:900, max:900 };
let players = {};
let boost = false;
let cooldowns = {};

/* ================= UI ================= */
function updateBars(){
    bossHP.style.width = (boss.hp/boss.max*100)+"%";
    chatHPdiv.style.width = (chatHP.hp/chatHP.max*100)+"%";
}
const bossHP = document.getElementById("bossHP");
const chatHPdiv = document.getElementById("chatHP");
updateBars();

/* ================= ENTITIES ================= */
function getPlayer(user,color){
    if(!players[user]){
        players[user] = {
            x:120+Object.keys(players).length*40,
            y:360,
            color:color||"#fff",
            action:null,
            timer:0
        };
    }
    return players[user];
}

/* ================= DRAW ================= */
function drawBoss(){
    ctx.save();
    ctx.translate(650,250);
    ctx.fillStyle = boost ? "#ff0" : "#f33";
    ctx.beginPath();
    ctx.arc(0,0,60,0,Math.PI*2);
    ctx.fill();

    // eyes
    ctx.fillStyle="#000";
    for(let i=0;i<boss.eyes;i++){
        ctx.beginPath();
        ctx.arc(-15+i*15,-10,6,0,Math.PI*2);
        ctx.fill();
    }

    // horns
    if(boss.horns){
        ctx.strokeStyle="#fff";
        ctx.beginPath();
        ctx.moveTo(-30,-40); ctx.lineTo(-60,-80);
        ctx.moveTo(30,-40); ctx.lineTo(60,-80);
        ctx.stroke();
    }

    // spikes
    ctx.strokeStyle="#fff";
    for(let i=0;i<boss.spikes;i++){
        ctx.beginPath();
        ctx.moveTo(-40+i*40,40);
        ctx.lineTo(-20+i*40,80);
        ctx.stroke();
    }
    ctx.restore();
}

function drawStickman(p,name){
    ctx.strokeStyle=p.color;
    ctx.lineWidth=3;

    let x=p.x, y=p.y;

    // attack animation
    if(p.action==="attack"){
        x+=20;
    }

    ctx.beginPath(); // head
    ctx.arc(x,y-30,8,0,Math.PI*2); ctx.stroke();

    ctx.beginPath(); // body
    ctx.moveTo(x,y-22); ctx.lineTo(x,y+10); ctx.stroke();

    ctx.beginPath(); // arms
    ctx.moveTo(x-10,y-10); ctx.lineTo(x+10,y-10); ctx.stroke();

    ctx.beginPath(); // legs
    ctx.moveTo(x,y+10); ctx.lineTo(x-10,y+25);
    ctx.moveTo(x,y+10); ctx.lineTo(x+10,y+25);
    ctx.stroke();

    ctx.fillStyle=p.color;
    ctx.fillText(name,x-15,y+40);
}

function draw(){
    ctx.clearRect(0,0,c.width,c.height);
    drawBoss();

    for(let u in players){
        drawStickman(players[u],u);
        if(players[u].timer>0) players[u].timer--;
        else players[u].action=null;
    }

    requestAnimationFrame(draw);
}
draw();

/* ================= GAME LOGIC ================= */
setInterval(()=>{
    if(boss.hp<=0 || chatHP.hp<=0) return;
    let dmg=Math.floor(Math.random()*25+15);
    chatHP.hp=Math.max(0,chatHP.hp-dmg);
    updateBars();
},3000);

function canAct(u){
    let t=Date.now();
    if(!cooldowns[u]||t-cooldowns[u]>3000){
        cooldowns[u]=t; return true;
    }
}

/* ================= CHAT ================= */
ComfyJS.onChat = (user, msg, flags, extra) => {
    const userColor = extra?.userColor || "#ffffff";
    msg=msg.toLowerCase();
    if(!canAct(user)) return;
    let p = getPlayer(user, userColor);

    if(msg==="attack"){
        let dmg=Math.floor(Math.random()*30+20);
        if(boost) dmg*=2;
        boss.hp=Math.max(0,boss.hp-dmg);
        p.action="attack"; p.timer=20;
    }

    if(msg==="heal"){
        p.action="heal"; p.timer=20;
        chatHP.hp=Math.min(chatHP.max,chatHP.hp+60);
    }

    if(msg==="boost"){
        boost=true;
        document.getElementById("boost").style.display="block";
        setTimeout(()=>{
            boost=false;
            document.getElementById("boost").style.display="none";
        },6000);
    }
    updateBars();
};

ComfyJS.Init("jaedraze");
</script>
</body>
</html>
