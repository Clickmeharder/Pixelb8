<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chat Arena – Stickmen (No Prefix)</title>
<script src="https://unpkg.com/comfy.js/dist/comfy.min.js"></script>
<style>
body {
    margin:0;
    background:none;
    color:#e0f7ff;
    font-family:monospace;
    overflow:hidden;
}
canvas { display:block; margin:auto; }
#ui {
    position:absolute;
    top:10px; left:10px;
}
.bar { width:300px; height:18px; background:#222; margin-bottom:6px; }
.fill { height:100%; background:#ff4444; }
.chat { background:#44ffcc; }
#boost {
    margin-top:6px;
    color:#ff0;
    font-weight:bold;
    display:none;
}
</style>
</head>

<body>

<canvas id="c" width="900" height="500"></canvas>

<div id="ui">
    BOSS HP
    <div class="bar"><div id="bossHP" class="fill"></div></div>
    CHAT HP
    <div class="bar"><div id="chatHP" class="fill chat"></div></div>
    <div id="boost">⚡ BOOST ACTIVE ⚡</div>
    <div style="margin-top:6px;font-size:12px;opacity:.8;">
        Commands: <b>attack</b> <b>heal</b> <b>boost</b>
    </div>
</div>

<script>
const c = document.getElementById("c");
const ctx = c.getContext("2d");

/* ================= STATE ================= */
let boss = {
    hp:1200, max:1200,
    horns: Math.random()>0.5,
    spikes: Math.floor(Math.random()*3)+1,
    eyes: Math.floor(Math.random()*3)+1,
    flash:0
};

let chatHP = { hp:900, max:900 };
let players = {};
let boost = false;
let cooldowns = {};

/* ================= UI ================= */
const bossHP = document.getElementById("bossHP");
const chatHPdiv = document.getElementById("chatHP");

function updateBars(){
    bossHP.style.width = (boss.hp/boss.max*100)+"%";
    chatHPdiv.style.width = (chatHP.hp/chatHP.max*100)+"%";
}
updateBars();

/* ================= HELPERS ================= */
function normalizeColor(c){
    return (typeof c === "string" && c.startsWith("#")) ? c : "#ffffff";
}

function cleanMessage(msg){
    return msg.toLowerCase().replace(/[^a-z]/g,"");
}

/* ================= ENTITIES ================= */
function getPlayer(user,color){
    color = normalizeColor(color);
    if(!players[user]){
        players[user] = {
            x:120 + Object.keys(players).length * 45,
            y:360,
            color,
            action:null,
            timer:0
        };
    } else {
        players[user].color = color;
    }
    return players[user];
}

/* ================= DRAW ================= */
function drawBoss(){
    ctx.save();
    ctx.translate(650,250);

    ctx.fillStyle = boss.flash>0 ? "#fff" : (boost ? "#ff0" : "#f33");
    ctx.beginPath();
    ctx.arc(0,0,60,0,Math.PI*2);
    ctx.fill();

    ctx.fillStyle="#000";
    for(let i=0;i<boss.eyes;i++){
        ctx.beginPath();
        ctx.arc(-15+i*15,-10,6,0,Math.PI*2);
        ctx.fill();
    }

    if(boss.horns){
        ctx.strokeStyle="#fff";
        ctx.beginPath();
        ctx.moveTo(-30,-40); ctx.lineTo(-60,-80);
        ctx.moveTo(30,-40); ctx.lineTo(60,-80);
        ctx.stroke();
    }

    ctx.strokeStyle="#fff";
    for(let i=0;i<boss.spikes;i++){
        ctx.beginPath();
        ctx.moveTo(-40+i*40,40);
        ctx.lineTo(-20+i*40,80);
        ctx.stroke();
    }
    ctx.restore();
}

function drawStickman(p,name){
    ctx.lineWidth=3;
    ctx.shadowColor="#000";
    ctx.shadowBlur=4;

    let x=p.x, y=p.y;

    if(p.action==="attack") x+=20;

    if(p.action==="heal"){
        ctx.strokeStyle="#44ff88";
        ctx.beginPath();
        ctx.arc(x,y-10,30-p.timer,0,Math.PI*2);
        ctx.stroke();
    }

    ctx.strokeStyle=p.color;

    ctx.beginPath(); ctx.arc(x,y-30,8,0,Math.PI*2); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x,y-22); ctx.lineTo(x,y+10); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x-10,y-10); ctx.lineTo(x+10,y-10); ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x,y+10); ctx.lineTo(x-10,y+25);
    ctx.moveTo(x,y+10); ctx.lineTo(x+10,y+25);
    ctx.stroke();

    ctx.shadowBlur=0;
    ctx.fillStyle=p.color;
    ctx.fillText(name,x-18,y+42);
}

function draw(){
    ctx.clearRect(0,0,c.width,c.height);
    drawBoss();

    for(let u in players){
        let p=players[u];
        drawStickman(p,u);
        if(p.timer>0) p.timer--;
        else p.action=null;
    }

    if(boss.flash>0) boss.flash--;
    requestAnimationFrame(draw);
}
draw();

/* ================= GAME LOGIC ================= */
setInterval(()=>{
    if(boss.hp<=0 || chatHP.hp<=0) return;
    let dmg=Math.floor(Math.random()*25+15);
    chatHP.hp=Math.max(0,chatHP.hp-dmg);
    updateBars();
},3000);

function canAct(u){
    let t=Date.now();
    if(!cooldowns[u]||t-cooldowns[u]>2500){
        cooldowns[u]=t;
        return true;
    }
    return false;
}

/* ================= CHAT ================= */
ComfyJS.onChat = (user, msg, flags, extra) => {
    const userColor = normalizeColor(extra?.userColor);
    const cmd = cleanMessage(msg);

    if(!canAct(user)) return;

    let p = getPlayer(user,userColor);

    if(cmd === "attack"){
        let dmg = Math.floor(Math.random()*30+20);
        if(boost) dmg*=2;
        boss.hp = Math.max(0,boss.hp-dmg);
        boss.flash = 6;
        p.action="attack"; p.timer=15;
    }

    if(cmd === "heal"){
        p.action="heal"; p.timer=20;
        chatHP.hp = Math.min(chatHP.max, chatHP.hp + 80);
    }

    if(cmd === "boost"){
        boost=true;
        document.getElementById("boost").style.display="block";
        setTimeout(()=>{
            boost=false;
            document.getElementById("boost").style.display="none";
        },6000);
    }

    updateBars();
};

ComfyJS.Init("jaedraze");
</script>
</body>
</html>

