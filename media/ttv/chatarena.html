<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chat Arena RPG</title>
<script src="https://unpkg.com/comfy.js/dist/comfy.min.js"></script>

<style>
body {
    margin:0;
    background:transparent;
    font-family:monospace;
}
canvas { display:block; margin:auto; }
</style>
</head>

<body>
<canvas id="c" width="900" height="500"></canvas>

<script>
const c = document.getElementById("c");
const ctx = c.getContext("2d");

ctx.font = "14px monospace";
ctx.textAlign = "center";

/* ================= GAME STATE ================= */

let area = 1;
let enemies = [];
let boss = null;
let players = {};

/* ================= PERSISTENCE ================= */

function loadStats(name){
    return JSON.parse(localStorage.getItem("stats_"+name)) || {
        combatLevel:1, combatXP:0,
        healLevel:1, healXP:0,
        loot:{ dmg:0, heal:0 }
    };
}

function saveStats(name){
    localStorage.setItem("stats_"+name, JSON.stringify(players[name].stats));
}

/* ================= HELPERS ================= */

function xpNeeded(level){
    return Math.floor(50 * Math.pow(1.6, level));
}

function spawnWave(){
    enemies = [];
    boss = null;

    for(let i=0;i<3+area;i++){
        enemies.push({
            x:500+i*40, y:360,
            hp:40+area*10,
            max:40+area*10,
            dead:false
        });
    }
}

function spawnBoss(){
    boss = {
        x:720, y:250,
        hp:200 + area*120,
        max:200 + area*120,
        dead:false
    };
}

/* ================= PLAYERS ================= */

function getPlayer(name,color){
    if(players[name]) return players[name];

    let stats = loadStats(name);

    players[name] = {
        name,
        color: color || "#fff",
        x:120+Object.keys(players).length*60,
        baseX:null,
        y:360,
        hp:100,
        maxHp:100,
        dead:false,
        blood:false,
        stats
    };
    players[name].baseX = players[name].x;
    return players[name];
}

/* ================= DRAW ================= */

function drawStickman(p){
    if(p.dead){
        ctx.fillStyle="darkred";
        ctx.beginPath();
        ctx.arc(p.x,p.y+30,18,0,Math.PI*2);
        ctx.fill();
        return;
    }

    ctx.strokeStyle=p.color;
    ctx.lineWidth=4;

    ctx.beginPath(); ctx.arc(p.x,p.y-35,10,0,Math.PI*2); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(p.x,p.y-25); ctx.lineTo(p.x,p.y+15); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(p.x-15,p.y-5); ctx.lineTo(p.x+15,p.y-5); ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(p.x,p.y+15); ctx.lineTo(p.x-15,p.y+35);
    ctx.moveTo(p.x,p.y+15); ctx.lineTo(p.x+15,p.y+35);
    ctx.stroke();

    ctx.fillStyle=p.color;
    ctx.fillText(p.name,p.x,p.y+55);
}

function drawEnemies(){
    enemies.forEach(e=>{
        if(e.dead) return;
        ctx.fillStyle="#888";
        ctx.beginPath();
        ctx.arc(e.x,e.y-20,15,0,Math.PI*2);
        ctx.fill();
    });
}

function drawBoss(){
    if(!boss || boss.dead) return;
    ctx.fillStyle="#f33";
    ctx.beginPath();
    ctx.arc(boss.x,boss.y,60,0,Math.PI*2);
    ctx.fill();
}

function loop(){
    ctx.clearRect(0,0,c.width,c.height);

    drawEnemies();
    drawBoss();

    Object.values(players).forEach(drawStickman);
    requestAnimationFrame(loop);
}
loop();

/* ================= COMBAT ================= */

function attackTarget(p){
    if(p.dead) return;

    let dmg = 10 + p.stats.combatLevel*3 + p.stats.loot.dmg;

    let target = enemies.find(e=>!e.dead);
    if(!target && boss && !boss.dead) target = boss;
    if(!target) return;

    target.hp -= dmg;
    p.stats.combatXP += 10;

    if(target.hp <= 0){
        target.dead = true;
        if(target === boss){
            dropLoot();
            area++;
            spawnWave();
        } else if(enemies.every(e=>e.dead)){
            spawnBoss();
        }
    }

    levelCheck(p,"combat");
    saveStats(p.name);
}

function healTarget(p,target){
    if(p.dead || target.dead) return;

    let heal = 15 + p.stats.healLevel*4 + p.stats.loot.heal;
    target.hp = Math.min(target.maxHp, target.hp + heal);

    p.stats.healXP += 10;
    levelCheck(p,"heal");
    saveStats(p.name);
}

function levelCheck(p,type){
    let lvl = type==="combat" ? p.stats.combatLevel : p.stats.healLevel;
    let xp = type==="combat" ? p.stats.combatXP : p.stats.healXP;

    if(xp >= xpNeeded(lvl)){
        if(type==="combat") p.stats.combatLevel++;
        else p.stats.healLevel++;
    }
}

/* ================= BOSS ATTACK ================= */

setInterval(()=>{
    let alive = Object.values(players).filter(p=>!p.dead);
    if(!alive.length) return;

    let t = alive[Math.floor(Math.random()*alive.length)];
    t.hp -= 20+area*5;

    if(t.hp<=0){
        t.hp=0;
        t.dead=true;
    }
},3000);

/* ================= LOOT ================= */

function dropLoot(){
    let alive = Object.values(players);
    if(!alive.length) return;

    let winner = alive[Math.floor(Math.random()*alive.length)];
    if(Math.random()<0.5) winner.stats.loot.dmg+=2;
    else winner.stats.loot.heal+=2;

    saveStats(winner.name);
}

/* ================= CHAT ================= */

ComfyJS.onChat = (user,msg,flags,extra)=>{
    let p = getPlayer(user,extra?.userColor);
    msg=msg.toLowerCase();

    if(msg==="attack") attackTarget(p);

    if(msg.startsWith("heal")){
        let parts = msg.split(" ");
        let target = players[parts[1]] || Object.values(players).find(x=>x.name!==user && !x.dead);
        if(target) healTarget(p,target);
    }
};

spawnWave();
ComfyJS.Init("jaedraze");
</script>
</body>
</html>
