<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chat Arena – Stickmen</title>
<script src="https://unpkg.com/comfy.js/dist/comfy.min.js"></script>

<style>
body {
    margin:0;
    background:transparent;
    color:#e0f7ff;
    font-family:monospace;
    overflow:hidden;
}
canvas { display:block; margin:auto; }

#ui {
    position:absolute;
    top:10px; left:10px;
}
.bar {
    width:320px;
    height:18px;
    background:#222;
    margin-bottom:6px;
}
.fill { height:100%; background:#ff4444; }
.chat { background:#44ffcc; }

#boost {
    margin-top:6px;
    color:#ff0;
    font-weight:bold;
    display:none;
}
</style>
</head>

<body>

<canvas id="c" width="900" height="500"></canvas>

<div id="ui">
    BOSS HP
    <div class="bar"><div id="bossHP" class="fill"></div></div>
    CHAT HP
    <div class="bar"><div id="chatHP" class="fill chat"></div></div>
    <div id="boost">⚡ BOOST ACTIVE ⚡</div>
</div>

<script>
const c = document.getElementById("c");
const ctx = c.getContext("2d");

/* ================= STATE ================= */

let boss = {
    x: 720,
    y: 250,
    hp: 1200,
    max: 1200,
    attackTimer: 0,
    attacking: false,
    target: null
};

let players = {};
let boost = false;
let cooldowns = {};

/* ================= UI ================= */

const bossHP = document.getElementById("bossHP");
const chatHPdiv = document.getElementById("chatHP");

function updateBars(){
    bossHP.style.width = (boss.hp / boss.max * 100) + "%";

    let total = 0;
    let max = 0;
    for (let p of Object.values(players)) {
        total += p.hp;
        max += p.maxHp;
    }
    chatHPdiv.style.width = max ? (total / max * 100) + "%" : "0%";
}

/* ================= HELPERS ================= */

function normalizeColor(c){
    if(!c) return "#ffffff";
    if(!c.startsWith("#")) return "#" + c;
    return c;
}

function getPlayer(user, color){
    if(!players[user]){
        players[user] = {
            name: user,
            color: normalizeColor(color),
            x: 120 + Object.keys(players).length * 60,
            y: 360,
            baseX: null,
            hp: 100,
            maxHp: 100,
            action: null,
            timer: 0,
            hitFlash: 0
        };
        players[user].baseX = players[user].x;
        updateBars();
    }
    return players[user];
}

function canAct(u){
    let t = Date.now();
    if(!cooldowns[u] || t - cooldowns[u] > 2500){
        cooldowns[u] = t;
        return true;
    }
}

/* ================= DRAW ================= */

ctx.font = "14px monospace";
ctx.textAlign = "center";

function drawBoss(){
    ctx.save();
    ctx.translate(boss.x, boss.y);

    ctx.fillStyle = boss.attacking ? "#ff0" : "#f33";
    ctx.beginPath();
    ctx.arc(0,0,60,0,Math.PI*2);
    ctx.fill();

    ctx.fillStyle="#000";
    ctx.beginPath();
    ctx.arc(-15,-10,6,0,Math.PI*2);
    ctx.arc(15,-10,6,0,Math.PI*2);
    ctx.fill();

    ctx.restore();
}

function drawStickman(p){
    let x = p.x;
    let y = p.y;

    if(p.hitFlash > 0){
        ctx.strokeStyle = "#ff0000";
        p.hitFlash--;
    } else {
        ctx.strokeStyle = p.color;
    }

    ctx.lineWidth = 4;

    // head
    ctx.beginPath();
    ctx.arc(x, y-35, 10, 0, Math.PI*2);
    ctx.stroke();

    // body
    ctx.beginPath();
    ctx.moveTo(x, y-25);
    ctx.lineTo(x, y+15);
    ctx.stroke();

    // arms
    ctx.beginPath();
    ctx.moveTo(x-15, y-5);
    ctx.lineTo(x+15, y-5);
    ctx.stroke();

    // legs
    ctx.beginPath();
    ctx.moveTo(x, y+15);
    ctx.lineTo(x-15, y+35);
    ctx.moveTo(x, y+15);
    ctx.lineTo(x+15, y+35);
    ctx.stroke();

    // name
    ctx.fillStyle = p.color;
    ctx.fillText(p.name, x, y+55);

    // hp bar
    ctx.fillStyle="#000";
    ctx.fillRect(x-20, y+62, 40, 5);
    ctx.fillStyle="#44ff44";
    ctx.fillRect(x-20, y+62, 40 * (p.hp / p.maxHp), 5);
}

function draw(){
    ctx.clearRect(0,0,c.width,c.height);

    drawBoss();

    for(let p of Object.values(players)){
        drawStickman(p);

        if(p.action === "attack"){
            p.x += (boss.x - 120 - p.x) * 0.25;
            if(Math.abs(p.x - (boss.x - 120)) < 5){
                p.action = "return";
            }
        } else if(p.action === "return"){
            p.x += (p.baseX - p.x) * 0.25;
            if(Math.abs(p.x - p.baseX) < 2){
                p.x = p.baseX;
                p.action = null;
            }
        }
    }

    requestAnimationFrame(draw);
}
draw();

/* ================= BOSS ATTACK ================= */

setInterval(()=>{
    let alive = Object.values(players).filter(p => p.hp > 0);
    if(alive.length === 0 || boss.hp <= 0) return;

    let target = alive[Math.floor(Math.random()*alive.length)];
    boss.attacking = true;
    boss.target = target;

    setTimeout(()=>{
        let dmg = Math.floor(Math.random()*20 + 15);
        target.hp = Math.max(0, target.hp - dmg);
        target.hitFlash = 15;
        updateBars();
    },400);

    setTimeout(()=>{
        boss.attacking = false;
        boss.target = null;
    },800);

}, 3000);

/* ================= CHAT ================= */

ComfyJS.onChat = (user, msg, flags, extra) => {
    msg = msg.toLowerCase();
    const p = getPlayer(user, extra?.userColor);
    if(!canAct(user)) return;

    if(msg === "attack"){
        let dmg = Math.floor(Math.random()*30 + 20);
        if(boost) dmg *= 2;
        boss.hp = Math.max(0, boss.hp - dmg);
        p.action = "attack";
    }

    if(msg.startsWith("heal")){
        let parts = msg.split(" ");
        let target;

        if(parts[1] && players[parts[1]] && parts[1] !== user){
            target = players[parts[1]];
        } else {
            let others = Object.values(players).filter(x => x.name !== user && x.hp > 0);
            if(others.length) target = others[Math.floor(Math.random()*others.length)];
        }

        if(target){
            target.hp = Math.min(target.maxHp, target.hp + 35);
            target.hitFlash = 10;
        }
    }

    if(msg === "boost"){
        boost = true;
        document.getElementById("boost").style.display = "block";
        setTimeout(()=>{
            boost = false;
            document.getElementById("boost").style.display = "none";
        }, 6000);
    }

    updateBars();
};

ComfyJS.Init("jaedraze");
</script>
</body>
</html>
