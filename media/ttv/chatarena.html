<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chat Arena RPG</title>
<script src="https://unpkg.com/comfy.js/dist/comfy.min.js"></script>

<style>
body {
    margin:0;
    background:transparent;
    font-family:monospace;
}
canvas { display:block; margin:auto; }
#enemyUI {
    position:absolute;
    top:10px;
    right:10px;
    color:#fff;
    font-size:13px;
    text-align:right;
}
</style>
</head>

<body>

<canvas id="c" width="900" height="500"></canvas>
<div id="enemyUI"></div>

<script>
const c = document.getElementById("c");
const ctx = c.getContext("2d");
ctx.textAlign="center";

/* ================= GAME STATE ================= */

let area = 1;
let enemies = [];
let boss = null;
let players = {};
let enemyUI = document.getElementById("enemyUI");

/* ================= PERSISTENCE ================= */

function loadStats(name){
    return JSON.parse(localStorage.getItem("stats_"+name)) || {
        combatLevel:1, combatXP:0,
        healLevel:1, healXP:0,
        loot:{ dmg:0, heal:0 }
    };
}
function saveStats(name){
    localStorage.setItem("stats_"+name, JSON.stringify(players[name].stats));
}

/* ================= HELPERS ================= */

function xpNeeded(level){
    return Math.floor(40 * Math.pow(1.5, level));
}

/* ================= WAVES ================= */

function spawnWave(){
    enemies = [];
    boss = null;

    let count = Math.min(3 + area, 6);
    for(let i=0;i<count;i++){
        enemies.push({
            id:i,
            hp: 20 + area*5,
            max:20 + area*5,
            x:500+i*45,
            y:360,
            dead:false
        });
    }
}

function spawnBoss(){
    boss = {
        hp:120 + area*80,
        max:120 + area*80,
        x:720,
        y:250,
        dead:false
    };
}

/* ================= PLAYERS ================= */

function getPlayer(name,color){
    if(players[name]) return players[name];

    let stats = loadStats(name);

    players[name] = {
        name,
        color: color || "#fff",
        x:120+Object.keys(players).length*65,
        y:360,
        hp:100,
        maxHp:100,
        dead:false,
        stats
    };
    return players[name];
}

/* ================= DRAW ================= */

function drawHPBar(x,y,w,h,pct,color){
    ctx.fillStyle="#000";
    ctx.fillRect(x-w/2-1,y-1,w+2,h+2);
    ctx.fillStyle=color;
    ctx.fillRect(x-w/2,y,w*pct,h);
}

function drawStickman(p){
    if(p.dead){
        ctx.fillStyle="darkred";
        ctx.beginPath();
        ctx.arc(p.x,p.y+30,18,0,Math.PI*2);
        ctx.fill();
        return;
    }

    // HP bar
    drawHPBar(p.x,p.y-55,40,6,p.hp/p.maxHp,"#44ff88");

    ctx.lineWidth=6;
    ctx.strokeStyle="#000"; // outline
    stickmanPath(p);

    ctx.lineWidth=3;
    ctx.strokeStyle=p.color;
    stickmanPath(p);

    ctx.fillStyle=p.color;
    ctx.font="15px monospace";
    ctx.fillText(p.name,p.x,p.y+58);
}

function stickmanPath(p){
    ctx.beginPath(); ctx.arc(p.x,p.y-35,10,0,Math.PI*2); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(p.x,p.y-25); ctx.lineTo(p.x,p.y+15); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(p.x-15,p.y-5); ctx.lineTo(p.x+15,p.y-5); ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(p.x,p.y+15); ctx.lineTo(p.x-15,p.y+35);
    ctx.moveTo(p.x,p.y+15); ctx.lineTo(p.x+15,p.y+35);
    ctx.stroke();
}

function drawEnemies(){
    enemies.forEach(e=>{
        if(e.dead) return;
        drawHPBar(e.x,e.y-40,30,5,e.hp/e.max,"#ff5555");
        ctx.fillStyle="#aaa";
        ctx.beginPath();
        ctx.arc(e.x,e.y-20,14,0,Math.PI*2);
        ctx.fill();
    });
}

function drawBoss(){
    if(!boss || boss.dead) return;
    drawHPBar(boss.x,boss.y-75,80,8,boss.hp/boss.max,"#ff3333");
    ctx.fillStyle="#f33";
    ctx.beginPath();
    ctx.arc(boss.x,boss.y,60,0,Math.PI*2);
    ctx.fill();
}

function updateEnemyUI(){
    let txt = "";
    enemies.forEach((e,i)=>{
        if(!e.dead) txt += `Minion ${i+1}: ${e.hp}/${e.max}<br>`;
    });
    if(boss && !boss.dead){
        txt += `<b>Boss:</b> ${boss.hp}/${boss.max}`;
    }
    enemyUI.innerHTML = txt;
}

function loop(){
    ctx.clearRect(0,0,c.width,c.height);
    drawEnemies();
    drawBoss();
    Object.values(players).forEach(drawStickman);
    updateEnemyUI();
    requestAnimationFrame(loop);
}
loop();

/* ================= COMBAT ================= */

function levelCheck(p,type){
    let lvl = type==="combat" ? p.stats.combatLevel : p.stats.healLevel;
    let xp = type==="combat" ? p.stats.combatXP : p.stats.healXP;
    if(xp >= xpNeeded(lvl)){
        if(type==="combat") p.stats.combatLevel++;
        else p.stats.healLevel++;
    }
}

function attackTarget(p){
    if(p.dead) return;

    let dmg = 6 + p.stats.combatLevel*2 + p.stats.loot.dmg;
    let target = enemies.find(e=>!e.dead) || (boss && !boss.dead && boss);

    if(!target) return;
    target.hp -= dmg;
    p.stats.combatXP += 8;

    if(target.hp<=0){
        target.dead=true;
        if(enemies.every(e=>e.dead) && !boss) spawnBoss();
        if(target===boss){
            area++;
            spawnWave();
        }
    }
    levelCheck(p,"combat");
    saveStats(p.name);
}

function healTarget(p,target){
    if(p.dead || target.dead) return;
    let heal = 10 + p.stats.healLevel*3 + p.stats.loot.heal;
    target.hp = Math.min(target.maxHp,target.hp+heal);
    p.stats.healXP += 8;
    levelCheck(p,"heal");
    saveStats(p.name);
}

/* ================= ENEMY ATTACK ================= */

setInterval(()=>{
    let alive = Object.values(players).filter(p=>!p.dead);
    if(!alive.length) return;

    let target = alive[Math.floor(Math.random()*alive.length)];
    let dmg = 6 + area*2;
    target.hp -= dmg;

    if(target.hp<=0){
        target.hp=0;
        target.dead=true;
    }
},3500);

/* ================= CHAT ================= */

ComfyJS.onChat = (user,msg,flags,extra)=>{
    let p = getPlayer(user,extra?.userColor);
    msg = msg.toLowerCase();

    if(msg==="attack") attackTarget(p);

    if(msg.startsWith("heal")){
        let parts = msg.split(" ");
        let t = players[parts[1]] ||
                Object.values(players).filter(x=>x.name!==user && !x.dead)[0];
        if(t) healTarget(p,t);
    }
};

spawnWave();
ComfyJS.Init("jaedraze");
</script>
</body>
</html>
