<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixelb8 Visualizer Terminal</title>
    <style>
        :root {
            --bg-main: #1a1a1a;
            --bg-panel: #1e1e1e;
            --accent: #00d4ff;
            --text-dim: #888;
            --border: #2a2a2a;
        }

        body { 
            background: var(--bg-main); 
            color: #eee; 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            margin: 0; 
            overflow: hidden; 
        }

        canvas { 
            position: absolute; 
            top: 0; left: 0; 
            width: 100vw; height: 100vh; 
            z-index: 1;
        }

        /* Professional Sidebar HUD */
        .hud-sidebar {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 260px;
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
            padding: 20px;
            z-index: 100;
            border-radius: 4px;
            box-shadow: 10px 0 30px rgba(0,0,0,0.5);
            transition: transform 0.3s ease;
        }

        h2 { 
            font-size: 0.8rem; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            color: var(--accent); 
            margin-top: 0;
        }

        .input-group {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; }

        input, select, button {
            background: #111;
            border: 1px solid var(--border);
            color: white;
            padding: 8px;
            border-radius: 3px;
            font-size: 0.85rem;
            outline: none;
        }

        button {
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.2s;
            border-left: 3px solid var(--accent);
            margin-top: 10px;
        }

        button:hover { background: #222; border-color: white; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }

        #recordingStatus {
            font-size: 0.7rem;
            color: #ff4444;
            margin-top: 10px;
            display: none;
            animation: pulse 1s infinite;
        }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="hud-sidebar">
        <h2>Visualizer Terminal</h2>
        
        <div class="input-group">
            <label>Source Audio</label>
            <input type="file" id="audioFile" accept="audio/*">
        </div>

        <div class="input-group">
            <label>Visual Style</label>
            <select id="visualizerStyle">
                <option value="bars">Frequency Columns</option>
                <option value="wave">Oscilloscope</option>
                <option value="circles">Radial Pulse</option>
            </select>
        </div>

        <div class="input-group">
            <label>Accent Color</label>
            <input type="color" id="barColor" value="#00d4ff" style="height: 40px; padding: 2px;">
        </div>

        <audio id="audio" style="width: 100%; margin-top: 10px;"></audio>

        <button id="startRecording">Begin Data Capture</button>
        <button id="stopRecording" disabled>Finalize & Download</button>
        
        <div id="recordingStatus">‚óè RECORDING IN PROGRESS</div>
    </div>

    <canvas id="visualizer"></canvas>

    <script>
        const audio = document.getElementById("audio");
        const fileInput = document.getElementById("audioFile");
        const canvas = document.getElementById("visualizer");
        const ctx = canvas.getContext("2d");
        const barColorInput = document.getElementById("barColor");
        const styleSelect = document.getElementById("visualizerStyle");
        const startBtn = document.getElementById("startRecording");
        const stopBtn = document.getElementById("stopRecording");
        const recStatus = document.getElementById("recordingStatus");

        let audioCtx, analyser, source, bufferLength, dataArray;
        let mediaRecorder, recordedChunks = [];

        // Set high-res canvas size
        function resize() {
            canvas.width = window.innerWidth * window.devicePixelRatio;
            canvas.height = window.innerHeight * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
        }
        window.addEventListener('resize', resize);
        resize();

        fileInput.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (file) audio.src = URL.createObjectURL(file);
        });

        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            source = audioCtx.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            analyser.fftSize = 512;
            bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
            render();
        }

        function render() {
            requestAnimationFrame(render);
            analyser.getByteFrequencyData(dataArray);

            // Clean background
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);

            const color = barColorInput.value;
            const style = styleSelect.value;

            if (style === "bars") drawBars(color);
            else if (style === "wave") drawWave(color);
            else if (style === "circles") drawCircles(color);
        }

        function drawBars(color) {
            const barWidth = (window.innerWidth / bufferLength) * 2;
            let x = 0;
            for (let i = 0; i < bufferLength; i++) {
                const h = (dataArray[i] / 255) * (window.innerHeight * 0.6);
                ctx.fillStyle = color;
                // Add a slight glow to the bars
                ctx.shadowBlur = 15;
                ctx.shadowColor = color;
                ctx.fillRect(x, window.innerHeight - h, barWidth - 1, h);
                x += barWidth;
            }
            ctx.shadowBlur = 0;
        }

        function drawWave(color) {
            ctx.lineWidth = 3;
            ctx.strokeStyle = color;
            ctx.shadowBlur = 10;
            ctx.shadowColor = color;
            ctx.beginPath();
            const sliceWidth = window.innerWidth / bufferLength;
            let x = 0;
            for (let i = 0; i < bufferLength; i++) {
                const v = dataArray[i] / 128.0;
                const y = v * window.innerHeight / 2;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
                x += sliceWidth;
            }
            ctx.stroke();
            ctx.shadowBlur = 0;
        }

        function drawCircles(color) {
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            for (let i = 0; i < bufferLength; i += 4) {
                const radius = (dataArray[i] / 255) * (window.innerHeight * 0.4);
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }

        startBtn.onclick = () => {
            initAudio();
            recordedChunks = [];
            // Optimization: Capture at a fixed 60fps
            const stream = canvas.captureStream(60); 
            
            // Add audio track to video stream
            const audioStream = audio.captureStream ? audio.captureStream() : audio.mozCaptureStream();
            audioStream.getAudioTracks().forEach(track => stream.addTrack(track));

            mediaRecorder = new MediaRecorder(stream, { 
                mimeType: "video/webm;codecs=vp9",
                videoBitsPerSecond: 5000000 // 5Mbps for high quality
            });

            mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: "video/webm" });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = "SUSPECT_Capture.webm";
                a.click();
            };

            mediaRecorder.start();
            audio.play();
            startBtn.disabled = true;
            stopBtn.disabled = false;
            recStatus.style.display = "block";
        };

        stopBtn.onclick = () => {
            mediaRecorder.stop();
            audio.pause();
            startBtn.disabled = false;
            stopBtn.disabled = true;
            recStatus.style.display = "none";
        };

        audio.onplay = () => initAudio();
    </script>
</body>
</html>